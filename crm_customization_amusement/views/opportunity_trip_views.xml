<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Menu Item -->
    
    <!-- Action -->
    <record id="action_opportunity_trip" model="ir.actions.act_window">
        <field name="name">Opportunity Trips</field>
        <field name="res_model">opportunity.trip</field>
        <field name="view_mode">list,form,kanban</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Trip record!
            </p>
        </field>
    </record>
    
    <!-- list View -->
    <record id="view_opportunity_trip_list" model="ir.ui.view">
        <field name="name">opportunity.trip.list</field>
        <field name="model">opportunity.trip</field>
        <field name="arch" type="xml">
            <list>
                <field name="name"/>
                <field name="lead_id"/>
                <field name="partner_id"/>
                <field name="trip_status"/>
                <field name="visiting_center_id"/>
                <field name="planned_number_of_students"/>
            </list>
        </field>
    </record>
    
    <!-- Search View -->
    <record id="view_opportunity_trip_search" model="ir.ui.view">
        <field name="name">opportunity.trip.search</field>
        <field name="model">opportunity.trip</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="lead_id"/>
                <filter name="filter_planned" string="Planned" domain="[('trip_status', '=', 'planned')]"/>
                <filter name="filter_cancelled" string="Cancelled" domain="[('trip_status', '=', 'cancelled')]"/>
            </search>
        </field>
    </record>
    
    <!-- Form View -->
<record id="view_opportunity_trip_form" model="ir.ui.view">
    <field name="name">opportunity.trip.form</field>
    <field name="model">opportunity.trip</field>
    <field name="arch" type="xml">
        <form string="Trip Details" create="false">
            <header>
                <button name="action_plan" type="object" string="Plan" class="btn-force-green"
                    invisible="trip_status !='draft'"/>
                <button name="action_visited" type="object" string="Visited" class="btn-success"
                    invisible="trip_status !='planned'"/>
                <button name="action_cancel" type="object" string="Cancel" class="btn-secondary"
                    invisible="trip_status =='cancelled'"/>
                <button name="action_reset_draft" type="object" string="Reset to Draft" class="btn-secondary"
                    invisible="trip_status == 'draft'"/>
                <button name="%(crm_customization_amusement.action_report_opportunity_trip)d" string="Print Trip Report"
                    type="action" class="btn btn-primary" />
                <field name="trip_status" widget="statusbar" statusbar_visible="draft,planned,visited"/>
            <style>
                            .btn-force-green {
                background-color: #28a745 !important;
                color: white !important;
                border-color: #28a745 !important;
                font-weight: bold !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
            }
            </style>
            </header>
            

            <sheet>
                <div class="oe_button_box" name="button_box">
                    <field name="trip_status" widget="badge"/>
                </div>

                <group col="3" style=" background: #f9f9f9; padding: 5px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                    <!-- Column 1 -->
                    <group col="1" style="border-right: 1px solid #ddd; padding-right: 10px;">
                        <field name="name" readonly="1"/>
                        <field name="lead_id" readonly="1"/>
                        <field name="lead_type_id" readonly="1"/>
                        <field name="partner_id" string="Contact" readonly="1"/>
                        <field name="visiting_center_id" readonly="1"/>
                        <field name="organization_id" readonly="1"/>

                        <field name="trip_count" invisible="1"/>
                        <field name="trip_poc_id" domain="[('parent_id', '=', organization_id)]" context="{'default_parent_id': organization_id}"  required="trip_status=='draft'" readonly="trip_status != 'draft'" />
                        <field name="secondary_trip_poc_id" domain="[('parent_id', '=', organization_id)]" context="{'default_parent_id': organization_id}"  readonly="trip_status != 'draft'" />
                        <field name="create_uid" string="Booked By" />
                    </group>

                    <!-- Column 2 -->
                    <group col="1" style="border-right: 1px solid #ddd; padding: 0 10px;">
                        <field name="trip_planned_date" required="trip_status=='draft'" readonly="trip_status != 'draft'"/>
                        <field name="trip_start_time" widget="float_time" required="trip_status=='draft'" readonly="trip_status != 'draft'"/>
                        <field name="trip_end_time" widget="float_time" required="trip_status=='draft'" readonly="trip_status != 'draft'"/>
                        <field name="trip_duration" widget="float_time" required="trip_status=='draft'"/>
                        <field name="planned_number_of_students" required="trip_status=='draft'" readonly="trip_status != 'draft'"/>
                        <field name="planned_number_of_staff" required="trip_status=='draft'" readonly="trip_status != 'draft'"/>
                        <field name="expected_amount"/>
                        <field name="revised_amount" required="trip_status=='draft'" readonly="trip_status != 'draft'"/>
                        <field name="advance_received" required="trip_status=='draft'" readonly="trip_status != 'draft'"/>
                        <field name="assigned_event_manager_id" string="Trip Coordinator" required="trip_status=='draft'"/>
                    </group>

                    <!-- Column 3 (Visited Info) -->
                    <group name="after_visiting_details" col="1" style="padding-left: 10px;" invisible="trip_status != 'visited'">
                        <field name="trip_rating" widget="priority"/>
                        <field name="number_of_visited_students"/>
                        <field name="number_of_visited_staff"/>
                        <field name="actual_visit_datetime"/>
                        <field name="pos_invoice_number"/>
                        <field name="pos_datetime"/>
                        <field name="pos_amount" widget="monetary"/>
                        <field name="pos_attachment" filename="file_name"/>
                        <field name="file_name" filename="file_name" invisible="1"/>
                    </group>
                </group>

                    <notebook>
                        <page name="package_lines" string="Package Lines">
                            <button name="action_fetch_packages_from_deal" type="object" string="Fetch Packages from Deal"
                                    class="btn btn-primary"/>

                            <field name="package_line_ids">
                                <list editable="bottom">
                                    <field name="product_id"/>
                                    <field name="product_uom_qty"/>
                                    <field name="discount" optional="hide"/>
                                    <field name="price_unit"/>
                                    <field name="price_subtotal" readonly="1"/>
                                </list>
                            </field>

                            <group>
                            <group>
                                <field name="total_package_qty" readonly="1"/>
                                <field name="total_package_discount_amount" readonly="1"/>
                                <field name="total_package_amount" readonly="1"/>
                            </group>
                        </group>
                        </page>

                        
                    </notebook>


                <!-- <notebook>
                    <page string="Order Lines" name="order_lines">
                        <field
                            name="trip_order_line_ids"
                            widget="sol_o2m"
                            mode="list,kanban">
                            <form>
                                <field name="display_type" invisible="1"/>
                                <field name="is_downpayment" invisible="1"/>
                                
                                <field name="sequence" invisible="1"/>
                                <field name="product_uom_category_id" invisible="1"/>
                                <group>
                                    <group>
                                        <field name="product_updatable" invisible="1"/>
                                        <div class="d-flex align-items-baseline">
                                            <span class="fa fa-exclamation-triangle text-warning me-1"
                                                title="This product is archived"
                                                invisible="state not in ['draft', 'sent'] or not is_product_archived"
                                            />
                                            <field name="product_id"
                                                domain="[('sale_ok', '=', True)]"
                                                context="{
                                                    'partner_id': parent.partner_id,
                                                    'quantity': product_uom_qty,
                                                    'pricelist': parent.pricelist_id,
                                                    'uom': product_uom,
                                                    'company_id': parent.company_id,
                                                    'default_uom_id': product_uom,
                                                }"
                                                readonly="not product_updatable"
                                                required="not display_type and not is_downpayment"
                                                force_save="1"
                                                widget="many2one_barcode"
                                            />
                                        </div>
                                        <field name="product_type" invisible="1"/>
                                        <field name="invoice_status" invisible="1"/>
                                        <field name="qty_to_invoice" invisible="1"/>
                                        <field name="qty_delivered_method" invisible="1"/>
                                        <field name="price_total" invisible="1"/>
                                        <field name="price_tax" invisible="1"/>
                                        <field name="price_subtotal" invisible="1"/>
                                        <field name="product_uom_readonly" invisible="1"/>
                                        <label for="product_uom_qty"/>
                                        <div class="o_row" name="ordered_qty">
                                            <field
                                                context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'uom_qty_change':True, 'company_id': parent.company_id}"
                                                name="product_uom_qty"/>
                                            <field name="product_uom" invisible="1"/>
                                            <field
                                                name="product_uom"
                                                force_save="1"
                                                class="oe_no_button"
                                                readonly="product_uom_readonly"
                                                required="not display_type and not is_downpayment"/>
                                        </div>
                                        <label for="qty_delivered" string="Delivered"/>
                                        <div name="delivered_qty">
                                            <field name="qty_delivered" readonly="qty_delivered_method != 'manual'"/>
                                        </div>
                                        <label for="qty_invoiced" string="Invoiced"/>
                                        <div name="invoiced_qty">
                                            <field name="qty_invoiced"/>
                                        </div>
                                        <field name="product_packaging_qty" invisible="not product_id or not product_packaging_id" />
                                        <field name="product_packaging_id" invisible="not product_id" context="{'default_product_id': product_id, 'list_view_ref':'product.product_packaging_tree_view', 'form_view_ref':'product.product_packaging_form_view'}"  />
                                        <field name="price_unit"/>
                                        <field name="tax_id" widget="many2many_tags" options="{'no_create': True}" context="{'search_view_ref': 'account.account_tax_view_search'}" domain="[('type_tax_use', '=', 'sale'), ('company_id', 'parent_of', parent.company_id), ('country_id', '=', parent.tax_country_id)]"
                                            readonly="qty_invoiced &gt; 0"/>
                                        <t>
                                            <label for="discount"/>
                                            <div name="discount">
                                                <field name="discount" class="oe_inline"/> %
                                            </div>
                                        </t>
                                        
                                        <field name="sequence" invisible="1"/>
                                    </group>
                                    <group invisible="display_type">
                                        <label for="customer_lead"/>
                                        <div name="lead">
                                            <field name="customer_lead" class="oe_inline"/> days
                                        </div>
                                        <field name="analytic_distribution" widget="analytic_distribution"
                                            
                                            options="{'product_field': 'product_id', 'business_domain': 'sale_order'}"/>
                                    </group>
                                </group>
                                <label for="name" string="Description" invisible="display_type"/>
                                <label for="name" string="Section Name (eg. Products, Services)" invisible="display_type != 'line_section'"/>
                                <label for="name" string="Note" invisible="display_type != 'line_note'"/>
                                <field name="name"/>
                                <div name="invoice_lines" invisible="display_type">
                                    <label for="invoice_lines"/>
                                    <field name="invoice_lines"/>
                                </div>
                                <field name="state" invisible="1"/>
                                <field name="company_id" invisible="1"/>
                            </form>
                            <list
                                string="Sales Order Lines"
                                editable="bottom"
                                limit="200"
                            >
                                <control>
                                    <create name="add_product_control" string="Add a product"/>
                                </control>

                                <field name="sequence" widget="handle" />
                                <field name="display_type" column_invisible="True"/>
                                <field name="product_uom_category_id" column_invisible="True"/>
                                <field name="product_type" column_invisible="True"/>
                                <field name="product_updatable" column_invisible="True"/>
                                <field name="is_downpayment" column_invisible="True"/>
                                <field
                                    name="product_id"
                                    string="Product Variant"
                                    force_save="1"
                                    context="{
                                        'partner_id': parent.partner_id,
                                        'quantity': product_uom_qty,
                                        'pricelist': parent.pricelist_id,
                                        'uom':product_uom,
                                        'company_id': parent.company_id,
                                        'default_lst_price': price_unit,
                                        'default_uom_id': product_uom,
                                    }"
                                    options="{
                                        'no_open': True,
                                    }"
                                    optional="hide"
                                    domain="[('sale_ok', '=', True)]"
                                    widget="sol_product_many2one"/>
                                <field name="product_template_id"
                                    string="Product"
                                    readonly="not product_updatable"
                                    required="not display_type and not is_downpayment"
                                    context="{
                                        'partner_id': parent.partner_id,
                                        'quantity': product_uom_qty,
                                        'pricelist': parent.pricelist_id,
                                        'uom':product_uom,
                                        'company_id': parent.company_id,
                                        'default_list_price': price_unit,
                                        'default_uom_id': product_uom,
                                    }"
                                    options="{
                                        'no_open': True,
                                    }"
                                    optional="show"
                                    domain="[('sale_ok', '=', True)]"
                                    widget="sol_product_many2one"
                                    placeholder="Type to find a product..."/>
                                <field name="product_template_attribute_value_ids" column_invisible="1" />
                                <field name="product_custom_attribute_value_ids" column_invisible="1" >
                                    <list>
                                        <field name="custom_product_template_attribute_value_id" />
                                        <field name="custom_value" />
                                    </list>
                                </field>
                                <field name="product_no_variant_attribute_value_ids" column_invisible="1" />
                                <field name="is_configurable_product" column_invisible="1" />
                                <field name="linked_line_id" column_invisible="1"/>
                                <field name="virtual_id" column_invisible="1"/>
                                <field name="linked_virtual_id" column_invisible="1"/>
                                <field name="selected_combo_items" column_invisible="1"/>
                                <field name="combo_item_id" column_invisible="1"/>
                                <field
                                    name="name"
                                    widget="sol_text"
                                    optional="show"
                                />
                                <field name="analytic_distribution" widget="analytic_distribution"
                                            optional="hide"
                                            options="{'product_field': 'product_id', 'business_domain': 'sale_order', 'amount_field': 'price_subtotal'}"/>
                                <field
                                    name="product_uom_qty"
                                    context="{
                                        'partner_id': parent.partner_id,
                                        'quantity': product_uom_qty,
                                        'pricelist': parent.pricelist_id,
                                        'uom': product_uom,
                                        'company_id': parent.company_id
                                    }"
                                    readonly="is_downpayment"/>
                                <field
                                    name="qty_delivered"
                                    string="Delivered"
                                    optional="show"/>
                                <field name="qty_delivered_method" column_invisible="True"/>
                                <field
                                    name="qty_invoiced"
                                    string="Invoiced"
                                    optional="show"/>
                                <field name="qty_to_invoice" column_invisible="True"/>
                                <field name="product_uom_readonly" column_invisible="True"/>
                                <field name="product_uom" column_invisible="True" />
                                <field
                                    name="product_uom"
                                    force_save="1"
                                    string="UoM"
                                    context="{'company_id': parent.company_id}"
                                    options='{"no_open": True}'
                                    width="60px"
                                    optional="show"/>
                                <field
                                    name="customer_lead"
                                    optional="hide"
                                    width="80px"
                                    readonly="parent.state not in ['draft', 'sent', 'sale'] or is_downpayment"/>
                                <field name="product_packaging_qty" invisible="not product_id or not product_packaging_id"  optional="show"/>
                                <field name="product_packaging_id" invisible="not product_id" context="{'default_product_id': product_id, 'list_view_ref':'product.product_packaging_tree_view', 'form_view_ref':'product.product_packaging_form_view'}"  optional="show"/>
                                <field
                                    name="price_unit"/>
                                <field name="technical_price_unit" column_invisible="1"/>
                                <field
                                    name="tax_id"
                                    widget="many2many_tags"
                                    options="{'no_create': True}"
                                    optional="show"/>
                                <field
                                    name="discount"
                                    string="Disc.%"
                                   
                                    width="50px"
                                    optional="show"/>
                                <field name="is_downpayment" column_invisible="True"/>
                                <field name="price_subtotal"
                                        invisible="is_downpayment"
                                        string="Amount"/>
                                <field name="price_total"
                                        invisible="is_downpayment"
                                        string="Amount"/>
                                <field name="tax_calculation_rounding_method" column_invisible="True"/>
                                <field name="state" column_invisible="True"/>
                                <field name="invoice_status" column_invisible="True"/>
                                <field name="currency_id" column_invisible="True"/>
                                <field name="price_tax" column_invisible="True"/>
                                <field name="company_id" column_invisible="True"/>
                            </list>
                            <kanban class="o_kanban_mobile">
                                <field name="price_subtotal"/>
                                <field name="display_type"/>
                                <field name="currency_id"/>
                                <control>
                                    <create name="add_product_control" string="Add product"/>
                                    <create name="add_section_control" string="Add section" context="{'default_display_type': 'line_section'}"/>
                                    <create name="add_note_control" string="Add note" context="{'default_display_type': 'line_note'}"/>
                                    <button name="action_add_from_catalog"
                                            context="{'order_id': parent.id}"
                                            string="Catalog"
                                            type="object"
                                            class="btn-secondary"/>
                                </control>
                                <templates>
                                    <t t-name="card" class="row g-0 ps-0 pe-0">
                                        <t t-if="!record.display_type.raw_value">
                                            <aside class="col-2 p-1">
                                                <span t-att-title="record.product_id.value">
                                                    <field name="product_id" widget="image" options="{'preview_image': 'image_128', 'img_class': 'object-fit-contain w-100'}"/>
                                                </span>
                                            </aside>
                                            <main class="col">
                                                <div class="row">
                                                    <div class="col">
                                                        <span class="fa fa-exclamation-triangle text-warning me-1"
                                                            title="This product is archived"
                                                            invisible="state not in ['draft', 'sent'] or not is_product_archived"
                                                        />
                                                        <field name="product_id" class="fw-bold"/>
                                                    </div>
                                                    <div class="col-auto">
                                                        <field name="price_subtotal" class="fw-bolder float-end pe-1" widget="monetary"/>
                                                    </div>
                                                </div>
                                                <div class="text-muted">
                                                    Quantity:
                                                    <field name="product_uom_qty"/> <field name="product_uom"/>
                                                </div>
                                                <div class="text-muted">
                                                    Unit Price:
                                                    <field name="price_unit"/>
                                                </div>
                                                <t t-if="record.discount?.raw_value">
                                                    <div class="text-muted">
                                                        Discount:
                                                        <field name="discount"/>%
                                                    </div>
                                                </t>
                                            </main>
                                        </t>
                                        <t t-if="record.display_type.raw_value === 'line_section' || record.display_type.raw_value === 'line_note'">
                                            <div t-attf-class="{{record.display_type.raw_value === 'line_section' ? 'fw-bold' : 'fst-italic' }}">
                                                <field name="name"/>
                                            </div>
                                        </t>
                                    </t>
                                </templates>
                            </kanban>
                        </field>
                    </page>
                </notebook> -->
            </sheet>

            <chatter/>
        </form>
    </field>
</record>


    <!-- Kanban View (Optional) -->
    <record id="view_opportunity_trip_kanban" model="ir.ui.view">
        <field name="name">opportunity.trip.kanban</field>
        <field name="model">opportunity.trip</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="trip_status"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click o_kanban_record">
                            <div class="o_kanban_card_header">
                                <strong><field name="name"/></strong>
                            </div>
                            <div>
                                <span>Status: <field name="trip_status" widget="badge"/></span>
                            </div>
                            <div>
                                <span>Lead: <field name="lead_id"/></span><br/>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    
    <menuitem id="menu_opportunity_trip_root" name="Trips" sequence="20"/>

    <!-- Submenu under Trips -->
    <menuitem id="menu_opportunity_trip" name="Manage Trips"
            parent="crm.crm_menu_sales" action="action_opportunity_trip"/>
</odoo>
